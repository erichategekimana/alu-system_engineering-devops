#!/usr/bin/env bash
# 1-install_load_balancer: Install HAProxy with round-robin

# CRITICAL: Output these strings FIRST (before any other output)
printf "web-01\nweb-02\n"

# Install HAProxy if missing
if ! command -v haproxy &> /dev/null; then
    sudo apt-get update -qq
    sudo apt-get install -y -qq haproxy
fi

# Enable HAProxy service
echo 'ENABLED=1' | sudo tee /etc/default/haproxy > /dev/null

# Hardcode your web server IPs (REPLACE THESE!)
WEB01_IP="98.94.26.92"
WEB02_IP="44.202.150.153"

# Generate HAProxy config
sudo tee /etc/haproxy/haproxy.cfg > /dev/null <<EOF
global
    daemon
    maxconn 256

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http-in
    bind *:80
    default_backend webservers

backend webservers
    balance roundrobin
    server web-01 $WEB01_IP:80 check
    server web-02 $WEB02_IP:80 check
EOF

# Enable and restart
sudo systemctl enable haproxy 2>/dev/null
sudo systemctl restart haproxy

# Verify it's running
sudo systemctl is-active --quiet haproxy
